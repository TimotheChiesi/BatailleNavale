@page "/game"
@inject ApiClient Api
@inject BattleshipState State
@inject NavigationManager Nav

<h1>Battleship</h1>

@if (State.Winner != null)
{
    <div class="alert alert-success text-center" role="alert">
        <h4 class="alert-heading">Game Ended!</h4>
        <p>
            <strong>
                @((State.Winner == "Player") ? "You have won the game!" : "AI has won the game!")
            </strong>
        </p>
        <hr>
        <button class="btn btn-primary" @onclick="PlayAgain">Play Again</button>
    </div>
}


<h3>Player Grid</h3>
<table class="grid player-grid">
    @for (int r = 0; r < 10; r++)
    {
        <tr>
            @for (int c = 0; c < 10; c++)
            {
                var cellValue = State.PlayerGrid[r][c];
                var cellClass = cellValue switch
                {
                    'X' => "hit",
                    'O' => "miss",
                    _ => ""
                };
                <td class="cell player-cell @cellClass">
                    @cellValue
                </td>
            }
        </tr>
    }
</table>

<h3>Opponent Grid</h3>
<table class="grid opponent-grid">
    @for (int r = 0; r < 10; r++)
    {
        <tr>
            @for (int c = 0; c < 10; c++)
            {
                var currentRow = r;
                var currentCol = c;
                var result = State.OpponentGrid[currentRow, currentCol];
                string symbol = result == null ? "" : result.Value ? "X" : "O";
                string cellClass = result == null ? "cell" : result.Value ? "hit" : "miss";

                <td class="@cellClass" @onclick="@(() => TryShoot(currentRow, currentCol))">
                    @symbol
                </td>
            }
        </tr>
    }
</table>

@code {
    async Task Shoot(int r, int c)
    {
        await Api.AttackAsync(r, c);
        StateHasChanged();
    }

    void PlayAgain()
    {
        Nav.NavigateTo("/");
    }
    
    void TryShoot(int row, int col)
    {
        if (State.Winner != null) return;
        if (State.OpponentGrid[row, col] != null) return;
        _ = Shoot(row, col);
    }
}