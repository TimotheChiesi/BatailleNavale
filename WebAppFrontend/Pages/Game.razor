@page "/game"
@inject ApiClient Api
@inject BattleshipState State
@inject NavigationManager Nav

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>Battleship</h1>
    <button class="btn btn-danger" @onclick="PlayAgain">Restart Game</button>
</div>

@if (State.Winner != null)
{
    @if (State.Winner == "Player")
    {
        <div class="alert alert-success text-center" role="alert">
            <h4 class="alert-heading">Game Ended!</h4>
            <p>
                <strong>
                    "You have won the game!"
                </strong>
            </p>
            <hr>
            <button class="btn btn-primary" @onclick="PlayAgain">Play Again</button>
        </div>
    }
    else
    {
    <div class="alert alert-danger text-center" role="alert">
        <h4 class="alert-heading">Game Ended!</h4>
        <p>
            <strong>
                "AI has won the game!"
            </strong>
        </p>
        <hr>
        <button class="btn btn-primary" @onclick="PlayAgain">Play Again</button>
    </div>
    }
    
}

<div class="mb-3">
    <div class="card">
        <div class="card-header">
            Attack Status
        </div>
        <div class="card-body">
            @if (State.AttackStatus != null && State.AttackStatus.Any())
            {
                <ul class="list-group list-group-flush">
                    @foreach (var status in State.AttackStatus)
                    {
                        <li class="list-group-item">@status</li>
                    }
                </ul>
            }
        </div>
    </div>
</div>

<div class="row justify-content-center">

    <div class="col-6">
        <h3>Player Grid</h3>
        <div class="d-flex">
            
            <div class="d-flex flex-column" 
                 style="width: 35px; height: @(GridPixelSize)px; justify-content: space-around;
                        text-align: center; font-weight: bold; margin-top: 35px;">
                @for (int r = 0; r < State.GridSize; r++)
                {
                    <div style="height: 35px; display: flex; align-items: center; justify-content: center;">
                        @((char)('A' + r))
                    </div>
                }
            </div>

            <div class="d-flex flex-column">
                
                <div class="d-flex" style="width: @(GridPixelSize)px; height: 35px; justify-content: space-around; text-align: center; font-weight: bold;">
                    @for (int c = 0; c < State.GridSize; c++)
                    {
                        <div style="width: 35px; display: flex; align-items: center; justify-content: center;">
                            @(c + 1)
                        </div>
                    }
                </div>

                <div class="player-grid-container" style="width: @(GridPixelSize)px; height: @(GridPixelSize)px;"> 
                    <table class="grid player-grid" style="width: @(GridPixelSize)px; height: @(GridPixelSize)px;">
                        @for (int r = 0; r < State.GridSize; r++)
                        {
                            <tr>
                                @for (int c = 0; c < State.GridSize; c++)
                                {
                                    var cellValue = State.PlayerGrid[r][c];
                                    var cellClass = cellValue switch
                                    {
                                        'X' => "hit",
                                        'O' => "miss",
                                        _ => ""
                                    };
                                    <td class="cell player-cell @cellClass">
                                        @if (cellValue == 'O')
                                        {
                                            <img src="./images/miss.png" />
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </table>

                    @foreach (var ship in State.PlayerShips)
                    {
                        var CELL_STEP = 35;

                        var top = ship.StartRow * CELL_STEP;
                        var left = ship.StartCol * CELL_STEP;
                        
                        var shipStyle = string.Empty;
                        var orientation = "horizontal";
                        
                        if (ship.IsHorizontal) 
                        {
                            var length_pixels = ship.Size * CELL_STEP; 
                            shipStyle = $"top: {top}px; left: {left}px; width: {length_pixels}px; height: {CELL_STEP}px;";
                        }
                        else 
                        {
                            var length_pixels = ship.Size * CELL_STEP; 
                            shipStyle = $"top: {top}px; left: {left}px; width: {CELL_STEP}px; height: {length_pixels}px;";
                            orientation = "vertical";
                        }
                            
                        <div class="ship-overlay" style="@shipStyle">
                            <img src="@($"./images/Length{ship.Size}_{orientation}.png")" alt="Ship of size @ship.Size" />
                            
                            @for (int i = 0; i < ship.Size; i++)
                            {
                                var r = ship.IsHorizontal ? ship.StartRow : ship.StartRow + i;
                                var c = ship.IsHorizontal ? ship.StartCol + i : ship.StartCol;
                            
                                if (State.PlayerGrid[r][c] == 'X') 
                                {
                                    var hitStyle = ship.IsHorizontal 
                                        ? $"left: {i * CELL_STEP}px; top: 0; width: {CELL_STEP}px; height: {CELL_STEP}px;"
                                        : $"top: {i * CELL_STEP}px; left: 0; width: {CELL_STEP}px; height: {CELL_STEP}px;";
                                    <div class="ship-segment-overlay" style="@hitStyle">
                                        <img class="hit-overlay" src="./images/hit.png" />
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-6">
        <h3>Opponent Grid</h3>
        <div class="d-flex">
            
            <div class="d-flex flex-column" 
                 style="width: 35px; height: @(GridPixelSize)px; justify-content: space-around;
                        text-align: center; font-weight: bold; margin-top: 35px;">
                @for (int r = 0; r < State.GridSize; r++)
                {
                    <div style="height: 35px; display: flex; align-items: center; justify-content: center;">
                        @((char)('A' + r))
                    </div>
                }
            </div>

            <div class="d-flex flex-column">
                
                <div class="d-flex" style="width: @(GridPixelSize)px; height: 35px; justify-content: space-around; text-align: center; font-weight: bold;">
                    @for (int c = 0; c < State.GridSize; c++)
                    {
                        <div style="width: 35px; display: flex; align-items: center; justify-content: center;">
                            @(c + 1)
                        </div>
                    }
                </div>

                <table class="grid opponent-grid" style="width: @(GridPixelSize)px; height: @(GridPixelSize)px;">
                    @for (int r = 0; r < State.GridSize; r++)
                    {
                        <tr>
                            @for (int c = 0; c < State.GridSize; c++)
                            {
                                var currentRow = r;
                                var currentCol = c;
                                var result = State.OpponentGrid[currentRow, currentCol];
                                string cellClass = result == null ? "cell" : result.Value ? "hit" : "miss";

                                <td class="@cellClass" @onclick="@(() => TryShoot(currentRow, currentCol))">
                                    @if (result.HasValue)
                                    {
                                        if (result.Value)
                                        {
                                            <img src="./images/hit.png"/>
                                        }
                                        else
                                        {
                                            <img src="./images/miss.png"/>
                                        }
                                    }
                                </td>
                            }
                        </tr>
                    }
                </table>
            </div>
        </div>
    </div>

</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                Battle Log
            </div>
            <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                @if (State.History != null && State.History.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var entry in State.History
                           .Select((move, idx) => new { Move = move, Turn = idx + 1 })
                           .OrderByDescending(x => x.Turn))
                        {
                            var turn = entry.Move;
                            var aiAttacks = turn.AiAttacks;

                            <li class="list-group-item list-group-item-action" 
                                @onclick="() => OnRollback(entry.Turn - 1)">
                                
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-dark me-3">#@entry.Turn</span>

                                    <div class="flex-grow-1 d-flex justify-content-between">
                                        <span>
                                            <strong>You</strong> fired at
                                            <span class="badge bg-secondary">@ToCoords(turn.Row, turn.Col)</span>
                                            @if (turn.PlayerAttackSucceeded)
                                            {
                                                <span class="badge bg-danger ms-1">HIT</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-light text-dark ms-1">MISS</span>
                                            }
                                        </span>

                                        @if (aiAttacks.Any())
                                        {
                                            <span class="ms-3 border-start ps-3">
                                                <strong>AI</strong> fired at:
                                                @foreach (var aiAttack in aiAttacks)
                                                {
                                                    <span class="d-inline-block ms-2">
                                                        <span class="badge bg-secondary">@ToCoords(aiAttack.Row, aiAttack.Col)</span>
                                                        @if (aiAttack.AiAttackSucceeded)
                                                        {
                                                            <span class="badge bg-danger ms-1">HIT</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge bg-light text-dark ms-1">MISS</span>
                                                        }
                                                    </span>
                                                }
                                            </span>
                                        }
                                    </div>
                                </div>
                            </li>
                        }
                    </ul>
                }
                else
                {
                    <div class="text-muted text-center p-3">No moves yet. Start shooting!</div>
                }
            </div>
        </div>
    </div>
</div>

@code {
    private const int CELL_STEP = 35;
    private int GridPixelSize => State.GridSize * CELL_STEP;
    
    async Task Shoot(int r, int c)
    {
        await Api.AttackAsync(r, c);
        StateHasChanged();
    }

    async Task PlayAgain()
    {
        Nav.NavigateTo("/placement");
    }
    
    void TryShoot(int row, int col)
    {
        Console.WriteLine($"TryShoot: row={row}, col={col}, value={State.OpponentGrid[row, col]}");
        Console.WriteLine(State.OpponentGrid);
        if (State.Winner != null) return;
        if (State.OpponentGrid[row, col] != null) return;
        _ = Shoot(row, col);
    }
    
    string ToCoords(int row, int col)
    {
        char rowLetter = (char)('A' + row);
        return $"{rowLetter}{col + 1}";
    }

    async Task OnRollback(int index)
    {
        await Api.RollbackAsync(index);
        StateHasChanged();
    }
}
