@page "/multiplayerGame/{RoomId}/{PlayerId}"
@using Microsoft.AspNetCore.SignalR.Client
@inject ApiClient ApiClient
@inject BattleshipState State

<h1>Multiplayer Battleship</h1>

@if (_isLoading)
{
    <p>Loading game board...</p>
}
else if (_loadError)
{
    <p style="color:red">@_errorMessage</p>
}
else
{
    @* Winner Panel *@
    @if (State.Winner != null)
    {
        @if (State.Winner == PlayerId)
        {
            <div class="alert alert-success text-center" role="alert">
                <h4 class="alert-heading">Game Ended!</h4>
                <p><strong>You won the game!</strong></p>
            </div>
        }
        else
        {
            <div class="alert alert-danger text-center" role="alert">
                <h4 class="alert-heading">Game Ended!</h4>
                <p><strong>You lose the game!</strong></p>
            </div>
        }
        
    }
    
    <div class="mb-3">
        <div class="card">
            <div class="card-header">
                Attack Status
            </div>
            <div class="card-body">
                @if (State.AttackStatus != null && State.AttackStatus.Any())
                {
                    <ul class="list-group list-group-flush">
                        @foreach (var status in State.AttackStatus)
                        {
                            <li class="list-group-item">@status</li>
                        }
                    </ul>
                }
            </div>
        </div>
    </div>

    <h4>Turn: @State.CurrentPlayerTurn</h4>
    <div class="row justify-content-center">

        @* PLAYER GRID *@
        <div class="col-6">
            <h3>Your Grid</h3>
            <div class="player-grid-container" style="width: @(GridPixelSize)px; height: @(GridPixelSize)px;"> 
                    <table class="grid player-grid" style="width: @(GridPixelSize)px; height: @(GridPixelSize)px;">
                        @for (int r = 0; r < State.GridSize; r++)
                        {
                            <tr>
                                @for (int c = 0; c < State.GridSize; c++)
                                {
                                    var cellValue = State.PlayerGrid[r][c];
                                    var cellClass = cellValue switch
                                    {
                                        'X' => "hit",
                                        'O' => "miss",
                                        _ => ""
                                    };
                                    <td class="cell player-cell @cellClass">
                                        @if (cellValue == 'O')
                                        {
                                            <img src="./images/miss.png" />
                                        }
                                    </td>
                                }
                            </tr>
                        }
                    </table>

                    @foreach (var ship in State.PlayerShips)
                    {
                        var CELL_STEP = 35;

                        var top = ship.StartRow * CELL_STEP;
                        var left = ship.StartCol * CELL_STEP;
                        
                        var shipStyle = string.Empty;
                        var orientation = "horizontal";
                        
                        if (ship.IsHorizontal) 
                        {
                            var length_pixels = ship.Size * CELL_STEP; 
                            shipStyle = $"top: {top}px; left: {left}px; width: {length_pixels}px; height: {CELL_STEP}px;";
                        }
                        else 
                        {
                            var length_pixels = ship.Size * CELL_STEP; 
                            shipStyle = $"top: {top}px; left: {left}px; width: {CELL_STEP}px; height: {length_pixels}px;";
                            orientation = "vertical";
                        }
                            
                        <div class="ship-overlay" style="@shipStyle">
                            <img src="@($"./images/Length{ship.Size}_{orientation}.png")" alt="Ship of size @ship.Size" />
                            
                            @for (int i = 0; i < ship.Size; i++)
                            {
                                var r = ship.IsHorizontal ? ship.StartRow : ship.StartRow + i;
                                var c = ship.IsHorizontal ? ship.StartCol + i : ship.StartCol;
                            
                                if (State.PlayerGrid[r][c] == 'X') 
                                {
                                    var hitStyle = ship.IsHorizontal 
                                        ? $"left: {i * CELL_STEP}px; top: 0; width: {CELL_STEP}px; height: {CELL_STEP}px;"
                                        : $"top: {i * CELL_STEP}px; left: 0; width: {CELL_STEP}px; height: {CELL_STEP}px;";
                                    <div class="ship-segment-overlay" style="@hitStyle">
                                        <img class="hit-overlay" src="./images/hit.png" />
                                    </div>
                                }
                            }
                        </div>
                    }
                </div>
        </div>
        
        @* OPPONENT GRID *@
        <div class="col-6">
            <h3>Opponent Grid</h3>

            <table class="grid opponent-grid">
                @for (int r = 0; r < State.GridSize; r++)
                {
                    <tr>
                        @for (int c = 0; c < State.GridSize; c++)
                        {
                            int row = r;
                            int col = c;
                            var result = State.OpponentGrid[row, col];
                            string cellClass = !result.HasValue ? "cell"
                                : result.Value ? "hit"
                                : "miss";

                            <td class="@cellClass" @onclick="@(() => TryShoot(row, col))">
                                @if (result.HasValue)
                                {
                                    <img src="@(result.Value ? "./images/hit.png" : "./images/miss.png")" alt=""/>
                                }
                            </td>
                        }
                    </tr>
                }
            </table>
        </div>

    </div>

    @* BATTLE LOG *@
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">Battle Log</div>
                <div class="card-body" style="max-height:400px; overflow-y:auto;">
                    @if (State.History.Any())
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var move in ((IEnumerable<MoveLog>)State.History).Reverse())
                            {
                                <li class="list-group-item">
                                    @if (move is MultiplayerMoveLog mpMove && !string.IsNullOrEmpty(mpMove.AttackerId))
                                    {
                                        @if (mpMove.AttackerId == "You")
                                        {
                                            <strong class="text-primary">You</strong> 
                                            <span>fired at </span>
                                            <span class="badge bg-secondary">@ToCoords(mpMove.Row, mpMove.Col)</span>
                                            
                                            @if (mpMove.PlayerAttackSucceeded) 
                                            { <span class="badge bg-danger">HIT</span> }
                                            else 
                                            { <span class="badge bg-light text-dark">MISS</span> }
                                        }
                                        else
                                        {
                                            <strong class="text-danger">Opponent</strong> 
                                            <span>fired at </span>
                                            <span class="badge bg-secondary">@ToCoords(mpMove.Row, mpMove.Col)</span>
                                            
                                            @if (mpMove.PlayerAttackSucceeded) 
                                            { <span class="badge bg-danger">HIT</span> }
                                            else 
                                            { <span class="badge bg-light text-dark">MISS</span> }
                                        }
                                    }
                                    else
                                    {
                                        @* Fallback for base MoveLog objects or missing IDs *@
                                        <span class="text-muted">Unknown shot at </span>
                                        <span class="badge bg-secondary">@ToCoords(move.Row, move.Col)</span>
                                    }
                                </li>
                            }
                        </ul>
                    }
                </div>
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public string RoomId { get; set; } = null!;
    [Parameter] public string PlayerId { get; set; } = null!;

    private HubConnection? _hubConnection;
    private bool _isLoading = true;
    private bool _loadError;
    private string _errorMessage = "";
    
    private const int CELL_STEP = 35;
    private int GridPixelSize => State.GridSize * CELL_STEP;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Load your grid & ship placements from API
            await ApiClient.GetMultiplayerGameAsync(RoomId, PlayerId);
        }
        catch (Exception ex)
        {
            _loadError = true;
            _errorMessage = ex.Message;
        }
        finally
        {
            _isLoading = false;
        }

        // --- SIGNALR SETUP ---
        _hubConnection = new HubConnectionBuilder()
            .WithUrl("http://localhost:5120/battleHub")
            .WithAutomaticReconnect()
            .Build();

        _hubConnection.On<int, int, bool, MultiplayerMoveLog, List<string>?>("ReceiveAttack", (row, col, hit, moveLog, attackStatus) =>
        {
            InvokeAsync(() =>
            {
                State.RegisterOpponentAttack(row, col, hit);
                moveLog.AttackerId = "Opponent";
                State.AddTurnMultiplayer(moveLog);

                if (!hit)
                {
                    State.CurrentPlayerTurn = "Your turn";
                }

                if (attackStatus != null)
                {
                    State.AttackStatus = attackStatus
                    .Select(s => $"Your opponent: {s}")
                        .ToList();
                }
                
                
                StateHasChanged();
            });
        });
        
        _hubConnection.On<int, int, bool, string?, MultiplayerMoveLog?, List<string>?>("AttackResult", (row, col, hit, winner, moveLog, attackStatus) =>
        {
            InvokeAsync(() =>
            {
                if (moveLog != null)
                {
                    State.RegisterPlayerAttack(row, col, hit);
                    moveLog.AttackerId = "You";
                    State.AddTurnMultiplayer(moveLog);
                    if (winner != null)
                        State.Winner = winner;

                    if (!hit)
                    {
                        State.CurrentPlayerTurn = "Opponent's turn";
                    }
                }
                
                if (attackStatus != null)
                {
                    State.AttackStatus = attackStatus
                        .Select(s => $"You: {s}")
                        .ToList();
                }
                
                StateHasChanged();
            });
        });

        _hubConnection.On<string>("GameEnded", (winnerId) =>
        {
            State.Winner = winnerId;
            StateHasChanged();
        });

        await _hubConnection.StartAsync();

        var playerRejoin = new Player { PlayerId = PlayerId, Pseudo = "Rejoining..." };
        await _hubConnection.InvokeAsync("JoinRoom", RoomId, playerRejoin, State.GridSize);
    }

    void TryShoot(int row, int col)
    {
        if (State.Winner != null) return;
        if (State.OpponentGrid[row, col] != null) return;
        _ = _hubConnection?.InvokeAsync("PlayerAttack", RoomId, PlayerId, row, col);
    }

    string ToCoords(int row, int col)
    {
        return $"{(char)('A' + row)}{col + 1}";
    }
}
